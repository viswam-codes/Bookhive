<%- include('../partials/adminHeader.ejs') %>
<link
rel="stylesheet"
href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css"
    />


<link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    />

<style>
  .image-container {
    width: 50%; /* Each image container takes up half of the row */
    box-sizing: border-box;
    padding: 5px;
    float: left;
  }

  @media (max-width: 768px) {
    .image-container {
      width: 100%; /* On smaller screens, make each image container take up the full width */
    }
  }
</style>
<body>
  <!-- Crop Image Modal -->

  <div class="screen-overlay"></div>
  <aside class="navbar-aside" id="offcanvas_aside">
    <div class="aside-top">
      <a href="index.html" class="brand-wrap">
        <img
          src="/admin_assets/imgs/theme/logo3.png"
          class="logo"
          alt="Evara Dashboard"
        />
      </a>
      <div>
        <button class="btn btn-icon btn-aside-minimize">
          <i class="text-muted material-icons md-menu_open"></i>
        </button>
      </div>
    </div>
    <nav>
      <ul class="menu-aside">
        <li class="menu-item">
          <a class="menu-link" href="/admin/home">
            <i class="icon material-icons md-home"></i>
            <span class="text">Dashboard</span>
          </a>
        </li>
        <li class="menu-item">
          <a class="menu-link" href="/admin/user_management">
            <i class="icon material-icons md-person"></i>
            <span class="text">User Management</span>
          </a>
        </li>
        <li class="menu-item active">
          <a class="menu-link" href="/admin/product_management">
            <i class="icon material-icons md-shopping_bag"></i>
            <span class="text">Products Management</span>
          </a>
        </li>
        <li class="menu-item">
          <a class="menu-link" href="/admin/category_management">
            <i class="icon material-icons md-stars"></i>
            <span class="text">Category Management</span>
          </a>
        </li>
        <li class="menu-item">
          <a class="menu-link" href="/admin/order_management">
            <i class="icon material-icons md-shopping_cart"></i>
            <span class="text">Orders</span>
          </a>
        </li>
        <li class="menu-item">
          <a class="menu-link" href="/admin/coupen_management">
            <i class="icon material-icons md-shopping_bag"></i>
            <span class="text">Coupon</span>
          </a>
        </li>
        <li class="menu-item">
          <a class="menu-link" href="/admin/sales_report">
            <i class="icon material-icons md-add_box"></i>
            <span class="text">Sales Report</span>
          </a>
        </li>
      </ul>
      <hr />
      <ul class="menu-aside">
        <li class="menu-item ">
            <a class="menu-link" href="/admin/logout"> 
                <span class="text">Logout</span>
            </a>
         
        </li>
       
    </ul>
      <br />
      <br />
    </nav>
  </aside>
  <main class="main-wrap">
    <header class="main-header navbar">
      <div class="col-search"></div>
      <div class="col-nav">
        <button
          class="btn btn-icon btn-mobile me-auto"
          data-trigger="#offcanvas_aside"
        >
          <i class="material-icons md-apps"></i>
        </button>
        <ul class="nav">
          <li class="nav-item">
            <a class="nav-link btn-icon" href="#">
              <i class="material-icons md-notifications animation-shake"></i>
              <span class="badge rounded-pill">3</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link btn-icon darkmode" href="#">
              <i class="material-icons md-nights_stay"></i>
            </a>
          </li>
          <li class="nav-item">
            <a href="#" class="requestfullscreen nav-link btn-icon"
              ><i class="material-icons md-cast"></i
            ></a>
          </li>
          <li class="dropdown nav-item">
            <a
              class="dropdown-toggle"
              data-bs-toggle="dropdown"
              href="#"
              id="dropdownLanguage"
              aria-expanded="false"
              ><i class="material-icons md-public"></i
            ></a>
            <div
              class="dropdown-menu dropdown-menu-end"
              aria-labelledby="dropdownLanguage"
            >
              <a class="dropdown-item text-brand" href="#"
                ><img
                  src="assets/imgs/theme/flag-us.png"
                  alt="English"
                />English</a
              >
              <a class="dropdown-item" href="#"
                ><img
                  src="assets/imgs/theme/flag-fr.png"
                  alt="Français"
                />Français</a
              >
              <a class="dropdown-item" href="#"
                ><img
                  src="assets/imgs/theme/flag-jp.png"
                  alt="Français"
                />日本語</a
              >
              <a class="dropdown-item" href="#"
                ><img
                  src="assets/imgs/theme/flag-cn.png"
                  alt="Français"
                />中国人</a
              >
            </div>
          </li>
          <li class="dropdown nav-item">
            <a
              class="dropdown-toggle"
              data-bs-toggle="dropdown"
              href="#"
              id="dropdownAccount"
              aria-expanded="false"
            >
              <img
                class="img-xs rounded-circle"
                src="assets/imgs/people/avatar2.jpg"
                alt="User"
            /></a>
            <div
              class="dropdown-menu dropdown-menu-end"
              aria-labelledby="dropdownAccount"
            >
              <a class="dropdown-item" href="#"
                ><i class="material-icons md-perm_identity"></i>Edit Profile</a
              >
              <a class="dropdown-item" href="#"
                ><i class="material-icons md-settings"></i>Account Settings</a
              >
              <a class="dropdown-item" href="#"
                ><i class="material-icons md-account_balance_wallet"></i
                >Wallet</a
              >
              <a class="dropdown-item" href="#"
                ><i class="material-icons md-receipt"></i>Billing</a
              >
              <a class="dropdown-item" href="#"
                ><i class="material-icons md-help_outline"></i>Help center</a
              >
              <div class="dropdown-divider"></div>
              <a class="dropdown-item text-danger" href="#"
                ><i class="material-icons md-exit_to_app"></i>Logout</a
              >
            </div>
          </li>
        </ul>
      </div>
    </header>
    <section class="content-main">
      <div class="row">
        <div class="col-9">
          <div class="content-header">
            <h2 class="content-title">Add New Product</h2>
            <!-- <div>
                        <button class="btn btn-light rounded font-sm mr-5 text-body hover-up">Save to draft</button>
                        <button type="submit" class="btn btn-md rounded font-sm hover-up">Publish</button>
                    </div> -->
          </div>
        </div>
        <div class="col-lg-6">
          <div class="card mb-4">
            <div class="card-header">
              <h4>Basic</h4>
            </div>
            <div class="card-body">
              <form
                action="/admin/add_product"
                method="post"
                enctype="multipart/form-data"
                id="addProductForm"
              >
                <div class="mb-4">
                  <label for="product_name" class="form-label">Title</label>
                  <input
                    type="text"
                    placeholder="Type here"
                    class="form-control"
                    id="product_name"
                    name="title"
                  />
                  <div id="usernameError" class="error-message"></div>
                </div>
                <div class="mb-4">
                  <label for="author" class="form-label">Author</label>
                  <input
                    type="text"
                    placeholder="Type here"
                    class="form-control"
                    id="author"
                    name="author"
                  />
                  <div id="authorError" class="error-message"></div>
                </div>
                <div class="mb-4">
                  <label class="form-label">Full description</label>
                  <textarea
                    placeholder="Type here"
                    id="description"
                    class="form-control"
                    rows="4"
                    name="description"
                  ></textarea>
                  <div id="descriptionError" class="error-message"></div>
                </div>
                <div class="row">
                  <div class="col-lg-4">
                    <div class="mb-4">
                      <label class="form-label">Regular price</label>
                      <div class="row gx-2">
                        <input
                          placeholder="Enter Price"
                          type="text"
                          id="price"
                          class="form-control"
                          name="price"
                        />
                        <div id="priceError" class="error-message"></div>
                      </div>
                    </div>
                  </div>
                  <div class="col-lg-4">
                    <div class="mb-4">
                      <label class="form-label">Stock</label>
                      <input
                        placeholder="Enter the Quantity"
                        type="text"
                        class="form-control"
                        name="stock"
                        id="stock"
                      />
                      <div id="stockError" class="error-message"></div>
                    </div>
                  </div>
                  <div class="col-lg-4">
                    <div class="mb-4">
                      <label class="form-label" required>Category</label>
                      <select class="form-select" name="category">
                        <% cat.forEach(function(cats) { %>
                        <option><%=cats.name %></option>
                        <% }); %>
                      </select>
                      <div id="categoryError" class="error-message"></div>
                    </div>
                  </div>
                </div>
                <div class="card mb-4">
                  <div class="card-header">
                    <h4>Media</h4>
                  </div>
                  <div class="card-body">
                    <div class="input-upload">
                      <input
                        class="form-control"
                        type="file"
                        name="image"
                        id="image"
                        multiple
                      />
                    </div>
                    <div id="imageError" class="error-message"></div>
                  </div>
                </div>
                <div class="card mb-4;">
                  <div class="card-header">
                    <h4>Image Preview</h4>
                  </div>
                  <div class="card-body" style="overflow-x: auto">
                    <div
                      id="image-preview"
                      style="display: flex; flex-wrap: wrap"
                    >
                      <!-- Placeholder for image preview -->
                    </div>
                  </div>
                </div>

                <button
                  type="submit"
                  class="btn btn-md rounded font-sm hover-up"
                  value="Upload"
                  onclick="return validateForm()"
                >
                  Publish
                </button>
              </form>
            </div>
          </div>
          <!-- card end// -->
        </div>
      </div>

      <div class="modal fade" id="cropImageModal" tabindex="-1" aria-labelledby="cropImageModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="cropImageModalLabel">Crop Image</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="img-container">
                <img id="imageToCrop" src="" alt="Image to crop">
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              <button type="button" class="btn btn-primary" id="cropImageButton">Crop</button>
            </div>
          </div>
        </div>
      </div>
    <!-- Cropper.js CSS -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>

    <script>
      $(document).ready(function () {
        let selectedFiles = [];
        let cropper;
        let currentFile;
        let $cropImageModal = $("#cropImageModal");
  
        // Attach change event listener to file input
        $("input[type=file]").on("change", previewImages);
  
        // Function to preview selected images
        function previewImages() {
          let preview = $("#image-preview");
          let filesInput = $("input[type=file]");
          let files = filesInput[0].files;
  
          preview.empty(); // Clear existing preview
  
          for (let i = 0; i < files.length; i++) {
            let file = files[i];
            let reader = new FileReader();
  
            reader.onload = function (e) {
              let imageContainer = $("<div>").addClass("image-container");
  
              let img = $("<img>")
                .addClass("img-fluid mb-2")
                .attr("src", e.target.result)
                .css({
                  maxWidth: "100%",
                  height: "auto",
                })
                .click(function () {
                  openCropModal(e.target.result, file);
                });
  
              let deleteButton = $("<button>")
                .addClass("btn btn-danger mb-2")
                .text("Delete")
                .click(function () {
                  imageContainer.remove();
                  let index = selectedFiles.indexOf(file);
                  if (index !== -1) {
                    selectedFiles.splice(index, 1);
                  }
                  deleteFile(index);
                });
  
              imageContainer.append(img, deleteButton);
              preview.append(imageContainer);
            };
  
            reader.readAsDataURL(file);
            selectedFiles.push(file);
          }
        }
  
        // Function to open crop modal
        function openCropModal(imageSrc, file) {
          currentFile = file;
          let imageToCrop = $("#imageToCrop");
          imageToCrop.attr("src", imageSrc);
  
          $cropImageModal.modal("show");
  
          $cropImageModal.on("shown.bs.modal", function () {
            if (cropper) {
              cropper.destroy();
            }
            cropper = new Cropper(imageToCrop[0], {
              aspectRatio: NaN,
              viewMode: 0,
            });
          });
  
          $("#cropImageButton").click(function () {
            let croppedCanvas = cropper.getCroppedCanvas();
            let croppedImageDataUrl = croppedCanvas.toDataURL("image/png");
  
            let img = $(`img[src='${imageSrc}']`);
            img.attr("src", croppedImageDataUrl);
  
            cropper.destroy();
            cropper = null;
            $cropImageModal.modal("hide");
          });
  
          $cropImageModal.on("hidden.bs.modal", function () {
            if (cropper) {
              cropper.destroy();
              cropper = null;
            }
          });
        }
  
        // Function to delete file from selectedFiles array
        function deleteFile(index) {
          let newFiles = new DataTransfer();
          for (let i = 0; i < selectedFiles.length; i++) {
            if (i !== index) {
              newFiles.items.add(selectedFiles[i]);
            }
          }
          let filesInput = $("input[type=file]");
          filesInput[0].files = newFiles.files;
        }
      });
    </script>
  
    
      <script>
        function validateForm() {
          var title = document.getElementById("product_name").value;
          var author = document.getElementById("author").value;
          var description = document.getElementById("description").value;
          var price = document.getElementById("price").value;
          var stock = document.getElementById("stock").value;
          var image = document.getElementById("image").value;
          var category = document.querySelector(
            'select[name="category"]'
          ).value;
          var valid = true;

          // Username validation
          if (!title) {
            document.getElementById("usernameError").innerText =
              "Title is required";
            document.getElementById("usernameError").style.color = "red"; // Set color to red
            valid = false;
          } else {
            document.getElementById("usernameError").innerText = "";
          }

          if (!author) {
            document.getElementById("authorError").innerText =
              "Author is required";
            document.getElementById("authorError").style.color = "red"; // Set color to red
            valid = false;
          } else {
            document.getElementById("authorError").innerText = "";
          }

          if (!description) {
            document.getElementById("descriptionError").innerText =
              "Description is required";
            document.getElementById("descriptionError").style.color = "red";
            valid = false;
          } else {
            document.getElementById("descriptionError").innerText = "";
          }

          if (!price || parseFloat(price) < 0) {
            document.getElementById("priceError").innerText =
              "Price must be a non-negative number";
            document.getElementById("priceError").style.color = "red";
            valid = false;
          } else {
            document.getElementById("priceError").innerText = "";
          }

          if (!stock || parseFloat(stock) < 0) {
            document.getElementById("stockError").innerText =
              "Stock must be a non-negative number";
            document.getElementById("stockError").style.color = "red";
            valid = false;
          } else {
            document.getElementById("stockError").innerText = "";
          }

          if (!category) {
            document.getElementById("categoryError").innerText =
              "Category is required";
            document.getElementById("categoryError").style.color = "red";
            valid = false;
          } else {
            document.getElementById("categoryError").innerText = "";
          }

          // Image validation
          if (!image) {
            document.getElementById("imageError").innerText =
              "Image is required";
            document.getElementById("imageError").style.color = "red";
            valid = false;
          } else {
            var allowedExtensions = /(\.jpeg|\.jpg|\.png|\.webp)$/i;
            if (!allowedExtensions.exec(image)) {
              document.getElementById("imageError").innerText =
                "Only files with extensions .jpeg, .jpg, .png, .webp are allowed";
              document.getElementById("imageError").style.color = "red";
              valid = false;
            } else {
              document.getElementById("imageError").innerText = "";
            }
          }

          // Password validation
          if (!valid) {
            return false;
          }
        }
      </script>
    </section>
    <%- include('../partials/adminFooter.ejs') %>
  </main>
</body>
